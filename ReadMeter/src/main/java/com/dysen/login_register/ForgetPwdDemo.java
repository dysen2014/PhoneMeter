/** * 邮箱: dysen@outlook.com | dy.sen@qq.com * * 作者: 沈迪 [ sen dy ] * * 日期: 2015-6-25  下午2:52:10  2015   *  * 描述:  * */package com.dysen.login_register;import android.app.AlertDialog;import android.content.Context;import android.content.Intent;import android.graphics.Color;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.text.TextUtils;import android.view.LayoutInflater;import android.view.View;import android.view.View.OnClickListener;import android.widget.Button;import android.widget.EditText;import android.widget.TextView;import com.alibaba.fastjson.JSON;import com.dysen.info.DataInfo;import com.dysen.info.Plogin;import com.dysen.myUtil.MyActivityTools;import com.dysen.myUtil.ToastDemo;import com.dysen.myUtil.httpUtil.HttpExcTint;import com.dysen.mylibrary.utils.StatusBarUtil;import com.dysen.mylibrary.utils.kjframe.KJHttp;import com.dysen.mylibrary.utils.kjframe.http.HttpCallBack;import com.dysen.mylibrary.utils.kjframe.http.HttpParams;import com.dysen.mylibrary.utils.util.LogUtils;import com.dysen.mylibrary.utils.util.SharedPreUtils;import com.dysen.qj.wMeter.R;import com.dysen.table.tForgetPwd;import com.dysen.table.tLogin;/** *  * 邮箱: dysen@outlook.com | dy.sen@qq.com *  * 作者: 沈迪 [ sendy ] *  * 日期: 2015-6-25 下午2:52:10 *  * 描述: 忘记密码(更新密码) *  */public class ForgetPwdDemo extends MyActivityTools implements OnClickListener {	private String HTTP_IP = "";		Button  btnUpdatePwd;	EditText etUsername, etOldPwd, etNewPwd, etConfirmPwd;	public static DataInfo data;	private Handler handler;	private String updateUrl;	private byte[] sendData;	String logName, logPwd, mId, mOldPwd, mNewPwd, mConfirmPwd;	int logId;	private View v;	tForgetPwd tfp;	private String readNumber;	/**	 * sen dy	 * 	 * 2015-6-25 下午2:52:21	 */	@Override	protected void onCreate(Bundle savedInstanceState) {		// TODO Auto-generated method stub		super.onCreate(savedInstanceState);		setContentView(R.layout.activity_forget_pwd);		//透明状态栏		StatusBarUtil.setTransparent(this);		(this.findViewById(R.id.ll_back)).setOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				finish();			}		});		((TextView) this.findViewById(R.id.tv_hint)).setText("更新密码");		HTTP_IP = this.getText(R.string.HTTP_IP).toString();		readNumber = (String)SharedPreUtils.get(this, "read_id", "");		logName = (String)SharedPreUtils.get(this, "log_name", "");		logPwd = (String)SharedPreUtils.get(this, "log_pwd", "");		logId = (int)SharedPreUtils.get(this, "log_id", 0);		initId();//		myHandler();	}	private void initId() {		btnUpdatePwd = (Button) this.findViewById(R.id.btn_update_pwd);		etUsername = (EditText) this.findViewById(R.id.et_user_name);//		etUsername.setText(getIntent().getStringExtra("user_name"));		etUsername.setText(logName);		etOldPwd = (EditText) this.findViewById(R.id.et_old_pwd);		etNewPwd = (EditText) this.findViewById(R.id.et_new_pwd);		etConfirmPwd = (EditText) this.findViewById(R.id.et_confirm_pwd);		btnUpdatePwd.setOnClickListener(this);	}	private void myHandler() {		handler = new Handler() {			private String strMsg;			private DataInfo data;			@Override			public void handleMessage(Message msg) {				data = (DataInfo) msg.obj;				if (data == null) {					ToastDemo.myHint(ForgetPwdDemo.this, "不匹配 ！！！", 2);				} else {					strMsg = data.getMsg().toString();					if (data.getSuccess()) {						if ("查找成功".equals(strMsg)) {							ToastDemo.myHint(ForgetPwdDemo.this, strMsg, 5);							Plogin pl = JSON.parseObject(									JSON.toJSONString(data.getObj()),									Plogin.class);							Intent it = new Intent(ForgetPwdDemo.this, UpdatePwd.class);							it.putExtra("login_id", pl.getId());							it.putExtra("user_name", etUsername.getText().toString().trim());							startActivity(it);						} else {							ToastDemo.myHint(ForgetPwdDemo.this, strMsg, 5);						}					} else {						ToastDemo.myHint(ForgetPwdDemo.this, strMsg, 5);					}				}			}		};	}	/**	 * sen dy	 * 	 * 2015-6-25 下午3:10:51	 */	@Override	public void onClick(View v) {		switch (v.getId()) {		case R.id.btn_back:			finish();			break;		case R.id.btn_update_pwd:			updatePwd();			break;		}	}	private void updatePwd() {		mId =//				PhotoDemoActivity.loginId+""; 				etUsername.getText().toString().trim();		mOldPwd = etOldPwd.getText().toString().trim();		mNewPwd = etNewPwd.getText().toString().trim();		mConfirmPwd = etConfirmPwd.getText().toString().trim();		if (!TextUtils.isEmpty(mId) && !TextUtils.isEmpty(mOldPwd) && !TextUtils.isEmpty(mNewPwd) && !TextUtils.isEmpty(mConfirmPwd)){			System.out.println("mOldPwd="+mOldPwd+"\tlogPwd="+logPwd+"\t密码是否匹配:"+etOldPwd.equals(logPwd));			if(mOldPwd.equals(logPwd)){				if (mNewPwd.equals(mConfirmPwd)) {					updateHttp();				}else {					ToastDemo.myHint(getApplicationContext(), "两次密码不一致", 2);				}			}else {				ToastDemo.myHint(aty, "原始密码错误，请更正后再试", 2);			}		}else {			ToastDemo.myHint(this, "参数无效", 2);		}	}	private void updateHttp() {		v = LayoutInflater.from(this).inflate(				R.layout.uber_progress, null);		v.setBackgroundColor(Color.argb(0,0,0,0));		myStartGif(this, v, "正在更新密码 ");//	启动gif动画		KJHttp kjt = new KJHttp();		HttpParams params = new HttpParams();		params.put("logName", logName);		params.put("pw", mNewPwd);		params.put("id", logId);		System.out.println(""+HTTP_IP+"admin/appLogin/update?logName="+logName+"&pw="+mNewPwd+"&id="+logId);//		kjt.post(HTTP_IP+"tForgetPwd.json", null, new HttpCallBack() {		kjt.post(HTTP_IP+"admin/appLogin/update?", params, new HttpCallBack() {			@Override			public void onSuccess(String t) {				super.onSuccess(t);				if ("".equals(t)) {					System.out.println("更新应答为空");					alert.cancel();					return;				} else {					alert.cancel();					tfp = JSON.parseObject(t, tForgetPwd.class);						if (tfp.isSuccess()){							LogUtils.i(dbLogin.findAll(tLogin.class).size()>0?"更新后的密码1："+dbLogin.findAll(tLogin.class).get(0).getPw():"更新后的密码1："+"无数据");							int id = dbLogin.findAll(tLogin.class).get(0).getId();//							login.setReadNumber(readNumber);							login.setPw(etNewPwd.getText().toString().trim());							dbLogin.update(login, "id="+ id);							LogUtils.i(dbLogin.findAll(tLogin.class).size()>0?"更新后的密码："+dbLogin.findAll(tLogin.class).get(0).getPw():"更新后的密码："+"无数据");							startActivity(new Intent(getApplicationContext(), LoginDemo.class));							finish();						}else {}						ToastDemo.myHint(ForgetPwdDemo.this, tfp.getMsg(), 5);						System.out.println("返回信息是+" + t.toString());				}			}			@Override			public void onFailure(int t, String strMsg) {				super.onFailure(t, strMsg);				//加载失败的时候回调				System.out.println("http访问异常：" + strMsg);				if (HttpExcTint.hTimeout.equals(strMsg)){					ToastDemo.myHint(ForgetPwdDemo.this, "访问超时", 2);				}else if(HttpExcTint.hNoConnectServer.equals(strMsg)){					ToastDemo.myHint(ForgetPwdDemo.this, "访问失败", 2);				}else {					ToastDemo.myHint(ForgetPwdDemo.this, "访问异常", 2);				}				alert.cancel();			}			@Override			public void onLoading(long count, long current) {				super.onLoading(count, current);				if (current == count)					System.out.println("上传进度：" + current / count);			}//		});	}	public static AlertDialog alert;	/**	 * dysen 2015-7-11 上午11:45:15 info: 启动 动画 gif 播放	 */	public static void myStartGif(Context context, View v, String str) {		// 把该 Activity 添加到 activity列表里 方便退出时一下子退出所有activity		// QuitAllActivity.getInstance().addActivity(this);		alert = new AlertDialog.Builder(context).setTitle(str).setView(v).show();//            // 从xml中得到GifView的句柄//            GifView gf1 = (GifView) v.findViewById(R.id.gif1);//            // 设置Gif图片源//            gf1.setGifImage(R.drawable.loading);////            // 设置显示的大小，拉伸或者压缩//            gf1.setShowDimension(300, 300);//            // 设置加载方式：先加载后显示、边加载边显示、只显示第一帧再显示//            gf1.setGifImageType(GifView.GifImageType.COVER);	}}